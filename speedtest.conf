# ------------------------------
#  /etc/nginx/sites-enabled/speedtest.conf
# ------------------------------

upstream flask_backend {
    # Only 2 stable backends
    server 127.0.0.1:8080;
    server 127.0.0.1:8081;
}

server {
    listen 80;
    server_name _;

    root /home/utku_ayten/speed-test/static;
    index index.html;

    # === Static files ===
    location /static/ {
        alias /home/utku_ayten/speed-test/static/;
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
    }

    # === Front page ===
    location = / {
        try_files $uri $uri/ /index.html;
    }

    # === Download endpoint (range requests) ===
    location /internet-file {
        proxy_pass http://flask_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_set_header Host $host;
    }

    # === Upload endpoint (POST /upload) ===
    # === Pure NGINX upload endpoint (very fast) ===
location /upload {
    # accept up to 200MB per request (adjust freely)
    client_max_body_size 200M;

    # disable buffering â†’ maximize speed
    proxy_request_buffering off;
    proxy_buffering off;

    # NGINX processes the body but does NOT send it to Flask
    proxy_pass_request_body off;

    # fast 200 OK response after body drained
    return 200 "OK";
}

    # === Meta info ===
    location /meta {
        proxy_pass http://flask_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # === CORS for frontend JS ===
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Range,Content-Type,Origin,Accept' always;
    if ($request_method = OPTIONS) {
        return 204;
    }

    error_log /var/log/nginx/speedtest_error.log;
    access_log /var/log/nginx/speedtest_access.log;
}